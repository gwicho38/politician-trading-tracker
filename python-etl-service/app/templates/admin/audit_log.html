{% extends "admin/base.html" %}

{% block title %}Audit Log{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold text-gray-800 mb-6">Audit Log</h2>

<!-- Summary -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4 text-center">
        <div class="text-3xl font-bold text-gray-800">{{ fix_log | length }}</div>
        <div class="text-sm text-gray-500">Total Events</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
        {% set accept_count = fix_log | selectattr('action_type', 'equalto', 'accept_all_qq') | list | length %}
        <div class="text-3xl font-bold text-blue-600">{{ accept_count }}</div>
        <div class="text-sm text-gray-500">QQ Accepts</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
        {% set field_count = fix_log | selectattr('action_type', 'equalto', 'field_update') | list | length %}
        <div class="text-3xl font-bold text-green-600">{{ field_count }}</div>
        <div class="text-sm text-gray-500">Field Updates</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
        {% set resolve_count = fix_log | selectattr('action_type', 'equalto', 'mark_resolved') | list | length %}
        <div class="text-3xl font-bold text-purple-600">{{ resolve_count }}</div>
        <div class="text-sm text-gray-500">Resolutions</div>
    </div>
</div>

<!-- Audit Log Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-5 py-3 border-b">
        <h3 class="font-semibold text-gray-700">Validation Fix History</h3>
        <p class="text-xs text-gray-500">All data modification events from the validation admin</p>
    </div>
    <table class="w-full text-sm">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-left">Action</th>
                <th class="px-4 py-3 text-left hidden md:table-cell">Validation ID</th>
                <th class="px-4 py-3 text-left hidden md:table-cell">Disclosure ID</th>
                <th class="px-4 py-3 text-left hidden lg:table-cell">Field</th>
                <th class="px-4 py-3 text-left hidden lg:table-cell">Old Value</th>
                <th class="px-4 py-3 text-left hidden lg:table-cell">New Value</th>
                <th class="px-4 py-3 text-left">Performed By</th>
                <th class="px-4 py-3 text-left">When</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in fix_log %}
            <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-3">
                    {% if entry.action_type == 'accept_all_qq' %}
                    <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full">Accept QQ</span>
                    {% elif entry.action_type == 'field_update' %}
                    <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">Field Update</span>
                    {% elif entry.action_type == 'mark_resolved' %}
                    <span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full">Resolved</span>
                    {% elif entry.action_type == 'delete_trade' %}
                    <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full">Delete</span>
                    {% else %}
                    <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">{{ entry.action_type }}</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 hidden md:table-cell font-mono text-xs text-gray-500">
                    {% if entry.validation_result_id %}
                    <a href="/admin/detail/{{ entry.validation_result_id }}?key={{ api_key }}" class="text-indigo-600 hover:underline">
                        {{ entry.validation_result_id[:8] }}...
                    </a>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="px-4 py-3 hidden md:table-cell font-mono text-xs text-gray-500">
                    {{ entry.trading_disclosure_id[:8] if entry.trading_disclosure_id else '-' }}...
                </td>
                <td class="px-4 py-3 hidden lg:table-cell text-gray-600">{{ entry.field_changed or '-' }}</td>
                <td class="px-4 py-3 hidden lg:table-cell text-gray-500 text-xs max-w-[150px] truncate" title="{{ entry.old_value or '' }}">
                    {{ entry.old_value[:30] if entry.old_value else '-' }}
                </td>
                <td class="px-4 py-3 hidden lg:table-cell text-gray-700 text-xs max-w-[150px] truncate" title="{{ entry.new_value or '' }}">
                    {{ entry.new_value[:30] if entry.new_value else '-' }}
                </td>
                <td class="px-4 py-3 text-gray-600 text-xs">{{ entry.performed_by or 'admin' }}</td>
                <td class="px-4 py-3 text-gray-500 text-xs">{{ entry.performed_at[:16] if entry.performed_at else '-' }}</td>
            </tr>
            {% endfor %}
            {% if not fix_log %}
            <tr><td colspan="8" class="text-center py-8 text-gray-500">No audit log entries found.</td></tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
