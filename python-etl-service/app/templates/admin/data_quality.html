{% extends "admin/base.html" %}

{% block title %}Data Quality{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold text-gray-800 mb-6">Data Quality Monitoring</h2>

<!-- Stats -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4 text-center">
        <div class="text-3xl font-bold text-gray-800">{{ stats.total_records | default(0) | int }}</div>
        <div class="text-sm text-gray-500">Total Records</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
        <div class="text-3xl font-bold text-green-600">{{ stats.records_24h | default(0) | int }}</div>
        <div class="text-sm text-gray-500">New (24h)</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
        <div class="text-3xl font-bold text-blue-600">{{ stats.validation_match | default(0) | int }}</div>
        <div class="text-sm text-gray-500">Validation Matches</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
        <div class="text-3xl font-bold text-yellow-600">{{ stats.validation_mismatch | default(0) | int }}</div>
        <div class="text-sm text-gray-500">Mismatches</div>
    </div>
</div>

<!-- Data Freshness -->
<div class="bg-white rounded-lg shadow p-5 mb-6">
    <h3 class="font-semibold text-gray-700 mb-3">Data Freshness</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="border rounded p-3">
            <div class="text-sm text-gray-500">Newest Record</div>
            <div class="font-medium text-gray-800">{{ stats.newest_record[:16] if stats.newest_record != 'N/A' else 'N/A' }}</div>
        </div>
        <div class="border rounded p-3">
            <div class="text-sm text-gray-500">Records (7 days)</div>
            <div class="font-medium text-gray-800">{{ stats.records_7d | default(0) | int }}</div>
        </div>
        <div class="border rounded p-3">
            <div class="text-sm text-gray-500">Validation Coverage</div>
            <div class="font-medium text-gray-800">{{ stats.validation_total | default(0) | int }} results</div>
        </div>
    </div>
</div>

<!-- Quality Actions -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <!-- Ticker Validation -->
    <div class="bg-white rounded-lg shadow p-5">
        <h3 class="font-semibold text-gray-700 mb-3">Ticker Validation</h3>
        <p class="text-sm text-gray-500 mb-3">Validate ticker symbols against known patterns and exchange data.</p>
        <div class="flex items-center gap-3">
            <button type="button"
                    hx-post="/admin/api/validate-tickers"
                    hx-target="#ticker-results"
                    hx-indicator="#ticker-loading"
                    hx-vals='{"key": "{{ api_key }}"}'
                    class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700 text-sm">
                Run Ticker Validation
            </button>
            <div id="ticker-loading" class="htmx-indicator">
                <svg class="animate-spin h-5 w-5 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
        <div id="ticker-results" class="mt-3"></div>
    </div>

    <!-- Source Validation -->
    <div class="bg-white rounded-lg shadow p-5">
        <h3 class="font-semibold text-gray-700 mb-3">Source Validation</h3>
        <p class="text-sm text-gray-500 mb-3">Validate data against official House Clerk disclosure index.</p>
        <div class="flex items-end gap-3">
            <div>
                <label class="block text-sm text-gray-600 mb-1">Year</label>
                <select id="source-year" class="border rounded px-3 py-2 text-sm">
                    <option value="2026">2026</option>
                    <option value="2025" selected>2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                    <option value="2017">2017</option>
                    <option value="2016">2016</option>
                    <option value="2015">2015</option>
                    <option value="2014">2014</option>
                    <option value="2013">2013</option>
                    <option value="2012">2012</option>
                    <option value="2011">2011</option>
                    <option value="2010">2010</option>
                    <option value="2009">2009</option>
                    <option value="2008">2008</option>
                </select>
            </div>
            <a id="source-validate-link" href="/admin/api/validate-source?key={{ api_key }}&year=2025" target="_blank"
               class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm inline-block">
                Run Source Validation
            </a>
        </div>
    </div>
</div>

<!-- API Reference -->
<div class="bg-white rounded-lg shadow p-5">
    <h3 class="font-semibold text-gray-700 mb-3">Quality API Endpoints</h3>
    <div class="text-sm text-gray-600 space-y-2">
        <div class="flex gap-2"><code class="bg-gray-100 px-2 py-0.5 rounded text-xs">POST</code> <code>/quality/validate-tickers</code> - Validate ticker symbols</div>
        <div class="flex gap-2"><code class="bg-gray-100 px-2 py-0.5 rounded text-xs">POST</code> <code>/quality/audit-sources</code> - Audit source data</div>
        <div class="flex gap-2"><code class="bg-gray-100 px-2 py-0.5 rounded text-xs">GET</code> <code>/quality/freshness-report</code> - Data freshness report</div>
        <div class="flex gap-2"><code class="bg-gray-100 px-2 py-0.5 rounded text-xs">GET</code> <code>/admin/api/validate-source?year=2025</code> - Official source validation</div>
        <div class="flex gap-2"><code class="bg-gray-100 px-2 py-0.5 rounded text-xs">GET</code> <code>/admin/api/validate-charts</code> - Chart data validation</div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const apiKey = '{{ api_key }}';
    const yearSelect = document.getElementById('source-year');
    const link = document.getElementById('source-validate-link');

    yearSelect.addEventListener('change', function() {
        link.href = `/admin/api/validate-source?key=${apiKey}&year=${this.value}`;
    });
});
</script>
{% endblock %}
