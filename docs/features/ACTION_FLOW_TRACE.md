# Action Flow Trace: `start_action()` Call

## Overview
This document traces what happens when `start_action()` is called in the Data Collection page.

## Call Site Location
**File:** `1_ğŸ“¥_Data_Collection.py`  
**Lines:** 224-237

```python
if st.button("ğŸš€ Start Collection", ...):
    action_id = start_action(
        action_type="data_collection_start",
        action_name="Manual Data Collection",
        source="ui_button",
        user_id=user_id,
        action_details={...}
    )
    st.session_state.action_id = action_id
```

---

## Step-by-Step Execution Flow

### 1. **Function Call** â†’ `start_action()`
**File:** `src/politician_trading/utils/action_logger.py` (Line 388-395)

Convenience function that delegates to the global ActionLogger instance:

```python
def start_action(action_type: str, **kwargs) -> Optional[str]:
    """Convenience function to start tracking an action."""
    logger_instance = get_action_logger()
    return logger_instance.start_action(action_type=action_type, **kwargs)
```

### 2. **Get Global Logger Instance** â†’ `get_action_logger()`
**File:** `src/politician_trading/utils/action_logger.py` (Line 365-376)

Retrieves or creates a singleton ActionLogger instance:

```python
def get_action_logger(config: Optional[SupabaseConfig] = None) -> ActionLogger:
    global _action_logger
    
    if _action_logger is None:
        _action_logger = ActionLogger(config=config)
    
    return _action_logger
```

### 3. **ActionLogger Instance Method** â†’ `ActionLogger.start_action()`
**File:** `src/politician_trading/utils/action_logger.py` (Line 131-165)

This is where the actual work happens:

```python
def start_action(self, 
    action_type: str,
    action_name: Optional[str] = None,
    action_details: Optional[Dict[str, Any]] = None,
    source: str = "ui_button",
    user_id: Optional[str] = None,
    job_id: Optional[str] = None,
    session_id: Optional[str] = None,
) -> Optional[str]:
    """Start tracking an action. Returns an action_id for later updates."""
    
    # Calls log_action() internally with status="initiated"
    action_id = self.log_action(
        action_type=action_type,
        action_name=action_name,
        status="initiated",
        action_details=action_details,
        source=source,
        user_id=user_id,
        job_id=job_id,
        session_id=session_id,
    )
    
    if action_id:
        # Store action context for later updates
        self._current_actions[action_id] = {
            "action_type": action_type,
            "start_time": time.time(),
            "action_details": action_details or {},
        }
    
    return action_id
```

### 4. **Database Insert** â†’ `ActionLogger.log_action()`
**File:** `src/politician_trading/utils/action_logger.py` (Line 37-130)

Inserts a record into the `action_logs` table:

```python
def log_action(self,
    action_type: str,
    status: str,
    action_name: Optional[str] = None,
    action_details: Optional[Dict[str, Any]] = None,
    ...) -> Optional[str]:
    
    # Build action record
    action_record = {
        "action_type": action_type,
        "status": status,  # "initiated" for start_action
        "action_name": action_name,
        "action_details": action_details or {},
        "source": source,
        "user_id": user_id,
        "action_timestamp": datetime.now().isoformat(),
        ...other fields...
    }
    
    # Insert into Supabase
    response = self.db.client.table("action_logs").insert(action_record).execute()
    
    if response.data and len(response.data) > 0:
        action_id = response.data[0]["id"]  # UUID generated by Supabase
        logger.debug(f"Logged action: {action_type}")
        return action_id  # â† Returns the action ID
    
    return None
```

### 5. **Back in Data Collection Page** (Lines 237-238)

```python
st.session_state.action_id = action_id  # Store in session for later use
logger.info("Start Collection button clicked", metadata={...})
st.session_state.collection_running = True
st.rerun()  # â† Reruns the script
```

### 6. **Data Collection Workflow Execution** (Lines 260-370)

After rerun, `collection_running` is True, so this block executes:

```python
if st.session_state.collection_running:
    # Initialize workflow
    workflow = PoliticianTradingWorkflow(workflow_config)
    
    # Run the actual collection
    results = asyncio.run(workflow.run_full_collection())
    
    # Process results...
```

### 7. **Complete the Action** (Lines 330-344)

After collection completes:

```python
action_id = st.session_state.get("action_id")
if action_id:
    summary = results.get("summary", {})
    complete_action(  # â† Updates action_logs table status to "completed"
        action_id=action_id,
        result_message=f"Collected {summary.get('total_new_disclosures', 0)} new disclosures...",
        action_details={
            "new_disclosures": summary.get("total_new_disclosures", 0),
            "updated_disclosures": summary.get("total_updated_disclosures", 0),
            "jobs_completed": len(...),
            "total_jobs": len(...)
        }
    )
```

---

## Database Table Updated

**Table:** `action_logs`  
**Supabase Location:** Your project â†’ Tables â†’ `action_logs`

### Initial Record (from `start_action()`)
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "action_type": "data_collection_start",
  "action_name": "Manual Data Collection",
  "status": "initiated",
  "source": "ui_button",
  "user_id": "user@example.com",
  "action_details": {
    "us_congress": true,
    "lookback_days": 30,
    "max_retries": 3,
    ...
  },
  "action_timestamp": "2025-11-11T14:32:00.000Z",
  "created_at": "2025-11-11T14:32:00.000Z",
  ...
}
```

### Updated Record (from `complete_action()`)
```json
{
  ...same as above...
  "status": "completed",  // â† Changed to completed
  "result_message": "Collected 42 new disclosures...",
  "action_details": {  // â† Updated with results
    "new_disclosures": 42,
    "updated_disclosures": 8,
    "jobs_completed": 5,
    "total_jobs": 5
  },
  "completed_at": "2025-11-11T14:35:30.000Z",
  "duration_seconds": 210,
  "updated_at": "2025-11-11T14:35:30.000Z"
}
```

---

## Key Code Locations Summary

| What | Where | Line(s) |
|------|-------|---------|
| Button click handler | `1_ğŸ“¥_Data_Collection.py` | 220-237 |
| `start_action()` wrapper | `src/politician_trading/utils/action_logger.py` | 388-395 |
| `ActionLogger.start_action()` | `src/politician_trading/utils/action_logger.py` | 131-165 |
| `ActionLogger.log_action()` | `src/politician_trading/utils/action_logger.py` | 37-130 |
| Database insert | `src/politician_trading/utils/action_logger.py` | 107-115 |
| Workflow execution | `1_ğŸ“¥_Data_Collection.py` | 260-370 |
| Action completion | `1_ğŸ“¥_Data_Collection.py` | 330-344 |
| `complete_action()` wrapper | `src/politician_trading/utils/action_logger.py` | 403-410 |
| `ActionLogger.complete_action()` | `src/politician_trading/utils/action_logger.py` | 173-235 |

---

## Action Logger Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Collection Page (1_ğŸ“¥_Data_Collection.py) â”‚
â”‚                                                 â”‚
â”‚  "ğŸš€ Start Collection" button clicked           â”‚
â”‚  â†“                                              â”‚
â”‚  start_action(action_type="data_collection...") â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Action Logger Module                           â”‚
â”‚  (src/politician_trading/utils/action_logger.py)â”‚
â”‚                                                 â”‚
â”‚  start_action()                                 â”‚
â”‚  â”œâ”€â†’ get_action_logger()                        â”‚
â”‚  â”‚   â””â”€â†’ ActionLogger(config)                   â”‚
â”‚  â””â”€â†’ ActionLogger.start_action()                â”‚
â”‚      â””â”€â†’ ActionLogger.log_action()              â”‚
â”‚          â””â”€â†’ db.client.table("action_logs")     â”‚
â”‚              .insert(action_record)             â”‚
â”‚              .execute()                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Database                              â”‚
â”‚                                                 â”‚
â”‚  Table: action_logs                             â”‚
â”‚  Status: "initiated"                            â”‚
â”‚  action_id returned â† Used later for updates    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
        Workflow runs: workflow.run_full_collection()
                   â†“
        On completion:
        complete_action(action_id=..., result_message=..., ...)
                   â†“
        Status updated: "initiated" â†’ "completed"
```

---

## Related Files to Explore

### Testing
- `scripts/test_action_logging.py` - Full workflow examples
- `tests/unit/test_action_logger.py` - Unit tests

### Documentation
- `docs/ACTION_LOGGING_GUIDE.md` - Comprehensive guide
- `docs/ACTION_LOGGING_QUICKSTART.md` - Quick reference
- `docs/implementation/action_logging_implementation.md` - Architecture details

### Viewing Logs
- Go to **Action Logs** page (ğŸ“‹ tab in sidebar) in your Streamlit app
- Browse recent actions, statistics, and failed actions

---

## Response Flow Summary

1. **User clicks** "ğŸš€ Start Collection" button
2. **`start_action()`** inserts record with status="initiated"
3. **Action ID** returned and stored in `st.session_state`
4. **Page reruns** with `collection_running = True`
5. **Workflow executes** `workflow.run_full_collection()`
6. **Results returned** with summary statistics
7. **`complete_action()`** updates the action record with:
   - status = "completed"
   - result_message with summary
   - action_details with counts and metrics
   - duration_seconds calculated
8. **Page displays** results to user
9. **Action log entry** now shows complete record in database

---

## Key Functions Reference

### `start_action()` - Begin tracking
```python
from politician_trading.utils.action_logger import start_action

action_id = start_action(
    action_type="data_collection_start",
    action_name="Manual Data Collection",
    source="ui_button",
    user_id="user@example.com",
    action_details={...}
)
```

### `complete_action()` - Mark as done
```python
from politician_trading.utils.action_logger import complete_action

complete_action(
    action_id=action_id,
    result_message="Collection completed successfully",
    action_details={...results...}
)
```

### `fail_action()` - Mark as failed
```python
from politician_trading.utils.action_logger import fail_action

fail_action(
    action_id=action_id,
    error_message="Collection failed: database connection error",
    action_details={"error_code": "DB_CONNECTION_ERROR"}
)
```

---

## Query the Logs Programmatically

```python
from politician_trading.utils.action_logger import get_action_logger

logger = get_action_logger()

# Get recent actions
recent = logger.get_recent_actions(limit=10, action_type="data_collection_start")

# Get summary statistics
summary = logger.get_action_summary(days=7)
```

