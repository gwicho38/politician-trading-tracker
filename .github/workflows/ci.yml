name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Python ETL Service Tests
  etl-tests:
    name: ETL Service Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: python-etl-service

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio pytest-cov pytest-mock
        pip install -r requirements.txt

    - name: Run ETL tests
      run: |
        pytest tests/ -v --tb=short
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://test.supabase.co' }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY || 'test-key' }}

  # React Client Tests
  client-tests:
    name: Client Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test -- --run

    - name: Build
      run: npm run build

  # Elixir Phoenix Server Tests
  server-tests:
    name: Server Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: server_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Elixir
      uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.14'
        otp-version: '25'

    - name: Restore dependencies cache
      uses: actions/cache@v4
      with:
        path: server/deps
        key: ${{ runner.os }}-mix-${{ hashFiles('server/mix.lock') }}
        restore-keys: ${{ runner.os }}-mix-

    - name: Install dependencies
      run: mix deps.get

    - name: Create database
      run: mix ecto.create
      env:
        MIX_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/server_test

    - name: Run migrations
      run: mix ecto.migrate
      env:
        MIX_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/server_test

    - name: Run tests
      run: mix test
      env:
        MIX_ENV: test
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/server_test

  # Deploy to Fly.io (only on push to main, after all tests pass)
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: [etl-tests, client-tests, server-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Install zsh
      run: sudo apt-get update && sudo apt-get install -y zsh

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install UV
      uses: astral-sh/setup-uv@v4

    - name: Install mcli-framework
      run: uv tool install mcli-framework

    - name: Setup IPFS
      run: mcli self ipfs setup

    - name: Pull mcli workflows from IPFS
      run: mcli sync pull QmYUmxVLrYm5Qfj4KfBzP5TQsevMGNXiZPN5nVtzm5Yqrg

    - name: Install Flyctl
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Deploy all services
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      run: mcli run services deploy-all

  # Build Summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [etl-tests, client-tests, server-tests, deploy]
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ETL Service | ${{ needs.etl-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| React Client | ${{ needs.client-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Phoenix Server | ${{ needs.server-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy to Fly.io | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
