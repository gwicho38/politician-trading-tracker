name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Python ETL Service Tests
  etl-tests:
    name: ETL Service Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: python-etl-service

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio pytest-cov pytest-mock
        pip install -r requirements.txt
      continue-on-error: true

    - name: Run ETL tests
      run: |
        pytest tests/ -v --tb=short
      continue-on-error: true
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://test.supabase.co' }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY || 'test-key' }}

  # React Client Tests
  client-tests:
    name: Client Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: client/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run tests
      run: npm test -- --run

    - name: Build
      run: npm run build

  # Elixir Phoenix Server Tests
  server-tests:
    name: Server Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    steps:
    - uses: actions/checkout@v4

    - name: Set up Elixir
      uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.14'
        otp-version: '25'

    - name: Restore dependencies cache
      uses: actions/cache@v4
      with:
        path: server/deps
        key: ${{ runner.os }}-mix-${{ hashFiles('server/mix.lock') }}
        restore-keys: ${{ runner.os }}-mix-

    - name: Install dependencies
      run: mix deps.get

    - name: Run tests
      run: mix test
      continue-on-error: true

  # Build Summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [etl-tests, client-tests, server-tests]
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ETL Service | ${{ needs.etl-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| React Client | ${{ needs.client-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Phoenix Server | ${{ needs.server-tests.result }} |" >> $GITHUB_STEP_SUMMARY
